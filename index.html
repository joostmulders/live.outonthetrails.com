<!DOCTYPE html>
<html>
  <head>
    <title>Out on the trails live tracking</title>
    <link rel="stylesheet" href="./openlayers/css/ol.css" type="text/css">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <!--<script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>-->
    <script src="./openlayers/build/ol.js"></script>
    <script src="./jquery/jquery-3.2.0.js"></script>
    <link rel="stylesheet" href="./bootstrap/css/bootstrap.min.css">
    <script src="./bootstrap/js/bootstrap.js"></script>

    <style>
      #countdowntimer {
        position: absolute;
        top: .5em;
        left: 50px;
        font-weight: bold;
      }
    </style>
  </head>
    
  <body>
  <div id='countdowntimer'></div>
  <div id="map" style="width: 100%; height: 100%; position:fixed">
  <div id="popup">
  <div id="info">

        
    <script>
      // Constants
      var refreshrate = 90000; // The refresh rate at which the runner position is updated.
      var gpxFilePath = './course/course.gpx';
      var markerFilePath = './course/markers.xml';

      var raster = new ol.layer.Tile({
        source: new ol.source.OSM()
      });

      // Style definition of the track outline.
      var style = {
        'Point': new ol.style.Style({
          image: new ol.style.Circle({
            fill: new ol.style.Fill({
              color: 'rgba(0,126,118,0.4)'
            }),
            radius: 3,
            stroke: new ol.style.Stroke({
              color: '#007e76',
              width: 3
            })
          })
        }),
        'LineString': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: '#007e76',
            width: 3
          })
        }),
        'MultiLineString': new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: '#007e76',
            width: 4
          })
        })
      };

      // Define the styles of the icons used in the tracking..
      var iconStyles = {
          'checkpointicon': new ol.style.Style({
              image: new ol.style.Icon({
                  anchor: [0.5, 1],
                  src: './images/checkpoint.png',
                  scale: 0.3
              })
          }),

          'startfinishicon': new ol.style.Style({
              image: new ol.style.Icon({
                  anchor: [0.5, 1],
                  src: './images/startfinish.png',
                  scale: 0.3
              })
          }),

          'runnericon': new ol.style.Style({
              image: new ol.style.Icon({
                  anchor: [0.5, 1],
                  src: './images/singlerunner.png',
                  scale: 0.3
              })
          })
      };

      /*
       Load the GPX track as a vector layer.
       */
      var GPXTrack = new ol.layer.Vector({
          source: new ol.source.Vector({
              url: gpxFilePath,
              format: new ol.format.GPX()
          }),
          style: function(feature) {
              return style[feature.getGeometry().getType()];
          }
      });
        
        /*
        Load the checkpoints and start finish location.
        TODO: Add error handling to reading the checkpoints from the file.
        */

      var checkpointSource = new ol.source.Vector({
          //create empty vector
      });

      $(document).ready(function(){
          // Read the course markers from the XML file.
        $.ajax({
            type: "GET",
            url: markerFilePath,
            dataType: "xml",
            success: function(xml) {

                $(xml).find('marker').each(function(){
                    var name = $(this).find('name').text();
                    var description = $(this).find('description').text();
                    var distance = $(this).find('distance').text();
                    var longtitude = $(this).find('lon').text();
                    var latitude = $(this).find('lat').text();
                    var type = $(this).find('type').text();

                    addMarker(name, description, distance, longtitude, latitude, type);
                });
            }
        });
      });

      function addMarker(name, description, distance, longtitude, latitude, type){

          var icontype = '';

          if(type === 'checkpoint') icontype = 'checkpointicon';
          else if(type === 'startfinish') icontype = 'startfinishicon';
          else icontype = 'checkpointicon';

          checkpointSource.addFeature(
              new ol.Feature({
                name: name,
                description: description + '<br>' + distance,
                type: icontype,
                geometry: new ol.geom.Point(ol.proj.fromLonLat([+(longtitude), +(latitude)]))
              }));

      }

      // Create the vector layer with all the check point and start / finish markers.
      var checkPointLayer = new ol.layer.Vector({
          source: checkpointSource,
          style: function (feature) {
              return iconStyles[feature.get('type')];
          }
      });

      // Define the runner icon with the initial start location on the course.
      var runnerMarker = new ol.Feature({
          type: 'runnericon',
          geometry: new ol.geom.Point(ol.proj.fromLonLat([4.862983, 53.173950]))
      });

      // Create the vector source to hold the runner icon.
      var vectorSource = new ol.source.Vector({
          features: [runnerMarker]
      });

      // Create a vector layer to contain the runner marker icon.
      var runnerLayer = new ol.layer.Vector({
          source: vectorSource,
          style: function(feature) {
              return iconStyles[feature.get('type')];
          }
      });

      /*
      Create the map with the different layers.
      */
      var map = new ol.Map({
        layers: [raster, GPXTrack, checkPointLayer, runnerLayer],
        target: document.getElementById('map'),
        controls: ol.control.defaults().extend([
          new ol.control.FullScreen()]),
        view: new ol.View({
            center: [0, 0],
            zoom: 11
        })
      });

      // Zoom the map to fit the GPX track in the view.
      GPXTrack.getSource().on("change", function(evt) {
          extent = GPXTrack.getSource().getExtent();
          map.getView().fit(extent, map.getSize());
      });

      // Set the initial position of the runner icon to the current location of the tracker.
      setRunnerPosition();

      /*
      Create the refresh timer countdown.
      */
      var countdownCounter = refreshrate / 1000;
      var timer = window.setInterval(countdownTimerInterval, 1000);

      $('#countdowntimer').appendTo($('.ol-overlaycontainer'));

      function countdownTimerInterval(){

          countdownCounter--;

          var out = "Next refresh in: " + countdownCounter + 's';
          $('#countdowntimer').text(out);

          if (countdownCounter === 0)
              countdownCounter= refreshrate / 1000;

      }

      /*
      Set the tracker position every x seconds, defined by the refreshinterval.
      */
      var refreshTimer = window.setInterval(setRunnerPosition, refreshrate);
        
      /*
      Called on every refresh interval.
      */
      function setRunnerPosition(){

          $.ajax({
              url: './trackerinfo.php',
              success: function (response) {
                  // Process the response to retrieve the current location of the tracker and the timestamp of this position.
                  var responseObj = JSON.parse(response.toString());

                  if (responseObj !== null) {

                      var currentLat = +(responseObj.lat);
                      var currentLon = +(responseObj.lng);

                      vectorSource.clear();

                      runnerMarker.setGeometry(new ol.geom.Point(ol.proj.fromLonLat([currentLon, currentLat])));

                      vectorSource.addFeature(runnerMarker);
                  }
                  else {
                      // process the error.
                  }
              },
              error: function (response) {
                  // alert('[Error retrieving GPS tracker data] - ' + response.toString());

                  // process the error.
              }
          });
      }

      var element = document.getElementById('popup');

      var popup = new ol.Overlay({
          element: element,
          positioning: 'bottom-center',
          stopEvent: false,
          offset: [0, -50]
      });
      map.addOverlay(popup);


      //////

      // TODO: Fix the bug that causes the gps course to be clickable.

      //////

      //display popup on click
      map.on('click', function(evt){
          var feature = map.forEachFeatureAtPixel(evt.pixel,
              function(feature){
                  return feature;
              }
          );

          if (feature){
              popup.setPosition(feature.getGeometry().getCoordinates());

              $(element).attr('data-placement', 'auto top');
              $(element).attr('data-html', true);
              $(element).attr('data-container', 'body');
              $(element).attr('max-width', '100%');
              $(element).attr('data-original-title', feature.get('name'));
              $(element).attr('data-content', feature.get('description'));
              $(element).popover('show');
          }
          else{
              $(element).popover('destroy');
          }
      });


      // Change mouse cursor when over marker
      map.on('pointermove', function(e) {
          if (e.dragging) {
              $(element).popover('destroy');
              return;
          }

          var pixel = map.getEventPixel(e.originalEvent);
          var hit = map.hasFeatureAtPixel(pixel);
          map.getTarget().style.cursor = hit ? 'pointer' : '';
      });

    </script>
  </body>
</html>